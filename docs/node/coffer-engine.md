# Coffer共识引擎

#### 概述

Utility区块链采用了名为"Coffer"的自定义共识引擎，结合了芯片证明（PoIC）的元素和独特的VRF（可验证随机函数）基于权重的签名者选择机制。这个引擎直接与区块链的状态数据库（StateDB）中的Coffer数据结构交互，从而实现动态的共识过程。

#### VRF-基于权重的签名者选择

- 每个区块的签名者由上一个区块的签名者通过VRF机制选择。
- 签名者的选择基于他们的权重（在Coffer中定义），权重越高，被选中的概率越大。
- 使用VRF确保随机性，并通过公钥基础设施提供可验证性。

#### Coffer交互和自定义交易

- Coffer引擎直接从StateDB访问Coffer数据结构，管理签名者信息。
- 引擎处理一系列自定义交易，如更新超级账户和修改签名者数据。
- 自定义交易直接影响Coffer数据，从而影响未来区块的签名者选择。

#### 标准共识API实现

- `Author`: 确定给定区块的作者（签名者）地址。
- `VerifyHeader`: 验证单个区块头是否符合共识规则。
- `VerifyHeaders`: 并发验证一批区块头。
- `VerifyUncles`: 验证区块中叔块的合规性。
- `Prepare`: 初始化区块头的共识字段，执行必要的预处理。
- `Finalize`: 执行任何交易后的状态修改，但不组装区块。
- `FinalizeAndAssemble`: 执行状态修改并组装最终区块。
- `Seal`: 生成新的密封请求并异步推送结果。
- `SealHash`: 返回被密封前的区块哈希。
- `CalcDifficulty`: 计算新区块应有的难度。
- `APIs`: 提供与共识引擎相关的RPC API。
- `Close`: 终止共识引擎维护的任何后台线程。

#### 结论

Coffer引擎为Utility区块链提供了一个灵活且高效的共识机制，通过结合传统的权威证明和创新的VRF技术，实现了高安全性和公平性。通过自定义交易和对Coffer数据的直接操作，它能够灵活应对网络动态和治理需求。
